'use strict';

var webpack = require('webpack');
var baseConfig = require('./webpack.config.base');
var HtmlWebpackPlugin = require('html-webpack-plugin');
var ExtractTextPlugin = require('extract-text-webpack-plugin');
var today = new Date();
var date = today.getFullYear()+''+(today.getMonth()+1)+''+today.getDate();
var time = today.getHours() + '' + today.getMinutes() + '' + today.getSeconds();
var dateTime = date+''+time;

var config = Object.create(baseConfig);
config.plugins = [
  new webpack.optimize.OccurenceOrderPlugin(),
  new webpack.DefinePlugin({
    'process.env.NODE_ENV': JSON.stringify('production'),
    ENVIR: JSON.stringify(process.env.NODE_ENV)
  }),
  new webpack.optimize.UglifyJsPlugin({
    compressor: {
      screw_ie8: true,
      warnings: false
    },
    output: {
      comments: false
    }
  }),
  new HtmlWebpackPlugin({
    template: './index.production.html', // Move the index.html file...
    minify: { // Minifying it while it is parsed
      removeComments: true,
      collapseWhitespace: true,
      removeRedundantAttributes: true,
      useShortDoctype: true,
      removeEmptyAttributes: true,
      removeStyleLinkTypeAttributes: true,
      keepClosingSlash: true,
      minifyJS: true,
      minifyCSS: true,
      minifyURLs: true
    },
    inject: true // inject all files that are generated by webpack, e.g. bundle.js, style.css with the correct HTML tags
  }),
  new ExtractTextPlugin("style.css"),
];

config.module.loaders.push({
    test: /\.scss$/,
    loader: ExtractTextPlugin.extract('style-loader', 'css-loader!sass-loader')
});

config.output.filename = 'bundle.' + dateTime +  '.min.js';

module.exports = config;
